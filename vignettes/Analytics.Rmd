---
title: "Docket Analytics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Docket Analytics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
httr::config(timeout = 20000) 
```


This page provides preliminary data analytics on various NLWR dockets. 
Note that ADAMS limits search results to a maximum of 1,000 results and some 
documents are assigned multiple docket numbers.
The results presented here should be interpreted with these limitations.


Because the entire docket is being pulled for each project, the 1,000 document
per search limit would be exceeded if all the dockets were pulled in one request. 
To reduce the impact of this limit, each docket is queried independently and the 
resulting tibbles are combined.

```{r}
combined_NLWR_dockets =  nrcadams::docket_codex |>
  dplyr::filter(NLWR) |>
  dplyr::pull(DocketNumber) |>
  nrcadams::search_long_docket(number_of_intervals = 10) |>
  dplyr::left_join(nrcadams::docket_codex) |>
  dplyr::filter(NLWR) |>
  dplyr::select(-c(URL, Company, DocketNumber, NLWR)) |>
  dplyr::distinct()

docket_count = combined_NLWR_dockets |>
  dplyr::count(Project, sort = TRUE)

docket_count |>
  DT::datatable()
```

There are too many document types coded by ADAMS to effectively show on a plot 
(i.e., > 180).
As a result, the Type feild is binned to facilitate a bar plot of various 
reactor applications. 
The Shine application bar plot is topped out at the ADAMS maximum of 1,000 
documents.
The last update to this plot was at `r Sys.time()`.

```{r}
library(ggplot2)
combined_NLWR_dockets |>
  dplyr::mutate(
    Project = factor(Project, levels = docket_count |> dplyr::pull(Project)),
    Type = dplyr::case_when(
      Type |> stringr::str_detect("RAI") ~ "RAI",
      Type |> stringr::str_detect("SAR") ~ "Safety Analysis",
      Type |> stringr::str_detect("Safety Analysis") ~ "Safety Analysis",
      Type |> stringr::str_detect("SER") ~ "Safety Eval.",
      Type |> stringr::str_detect("Safety Evaluation") ~ "Safety Eval.",
      Type |> stringr::str_detect("Audit") ~ "Audit",
      Type |> stringr::str_detect("Legal") ~ "Legal",
      Type |> stringr::str_detect("Letter") ~ "Letter",
      Type |> stringr::str_detect("E-Mail") ~ "Letter",
      Type |> stringr::str_detect("Report") ~ "Report",
      Type |> stringr::str_detect("Slides") ~ "Slides",
      TRUE ~ "Other"
    )
  ) |>
  ggplot() +
    geom_bar(aes(y = Project, fill = Type)) +
    theme_bw() +
    labs(
      title = "Non-Light Water Reactor ADAMS Documents",
      subtitle =  paste("as of", Sys.Date())
    ) +
    xlab("Document Count")
```

The cumulative number of documents on a given ADAMS docket is also presented
as a function of document date. 
The plot below shows the number of documents submitted to a docket. This 
plot starts in 2018 because the Shine docket singularly dominates the plot in 
the pre-2018 time frame. 


```{r}
library(ggplot2)
grouped_NLWR_dockets = combined_NLWR_dockets |>
  dplyr::group_by(Project) |>
  dplyr::arrange(`Document Date`) |>
  dplyr::mutate(
    Project = factor(Project, levels = docket_count |> dplyr::pull(Project)),
    count = 1,
    `Document Count` = cumsum(count)
    ) |>
  dplyr::filter(`Document Date` > lubridate::ymd("2018-01-01"))

grouped_NLWR_dockets |>
  ggplot() +
    geom_step(aes(x = `Document Date`, y = `Document Count`, color = Project)) +
    theme_bw() +
    labs(
      title = "Non-Light Water Reactor ADAMS Documents",
      subtitle =  paste("as of", Sys.Date())
    )

```
